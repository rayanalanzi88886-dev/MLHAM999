// CONTEXTUAL_SUGGESTIONS.ts - نظام الاقتراحات الديناميكية حسب رد الخبير

/**
 * نظام ذكي يحلل رد الخبير ويقترح أسئلة مناسبة
 * يعمل بناءً على الكلمات المفتاحية في الرد
 */

// ===== 1. الكلمات المفتاحية وأسئلتها المرتبطة =====

const KEYWORD_SUGGESTIONS: Record<string, string[]> = {
  // أرقام ووقت
  'صباح': ['ما أفضل وقت في المساء؟', 'كيف أحافظ على هذا الروتين؟'],
  'مساء': ['ما أفضل وقت صباحاً؟', 'كيف أحافظ على الالتزام؟'],
  'يوم': ['كم مرة في الأسبوع؟', 'ما الجدول الأسبوعي المثالي؟'],
  'أسبوع': ['خطة شهرية', 'كيف أتابع التقدم؟'],
  'شهر': ['خطة ربع سنوية', 'كيف أقيس النتائج؟'],
  
  // خطوات وإجراءات
  'خطوة': ['ما الخطوة التالية؟', 'هل هناك اختصارات؟', 'كيف أتجنب الأخطاء؟'],
  'أولاً': ['ثم ماذا بعد ذلك؟', 'ما المدة الزمنية؟'],
  'ثانياً': ['والخطوة الثالثة؟', 'كيف أتأكد من النجاح؟'],
  'أخيراً': ['ماذا لو فشلت؟', 'نصائح إضافية؟'],
  
  // نصائح وتوصيات
  'أنصح': ['هل هناك بدائل؟', 'لماذا تنصح بهذا؟', 'أمثلة عملية؟'],
  'يفضل': ['ما السبب؟', 'هل هناك خيارات أخرى؟'],
  'يجب': ['هل هذا إلزامي؟', 'ماذا لو لم أفعل؟'],
  'ممكن': ['ما الخيارات المتاحة؟', 'أيها الأفضل؟'],
  
  // مالية
  'ريال': ['كيف أحسب التكلفة الكاملة؟', 'هل هناك خيارات أرخص؟', 'عروض وتخفيضات؟'],
  'تكلفة': ['ما الميزانية المناسبة؟', 'كيف أوفر المال؟'],
  'دفع': ['طرق الدفع المتاحة؟', 'هل يوجد تقسيط؟'],
  'سعر': ['هل السعر ثابت؟', 'متى تكون الأسعار أقل؟'],
  
  // حكومي وإجرائي
  'أبشر': ['كيف أحل مشاكل أبشر؟', 'البدائل إذا تعطل؟', 'التحديث الأخير؟'],
  'ناجز': ['خطوات التسجيل في ناجز', 'حل مشاكل الدخول'],
  'وزارة': ['رقم التواصل', 'مواعيد العمل', 'الفروع القريبة'],
  'رخصة': ['متطلبات التجديد', 'الرسوم', 'المدة الزمنية'],
  
  // تسويق ومحتوى
  'محتوى': ['أفكار محتوى إضافية', 'أدوات إنشاء المحتوى', 'كيف أقيس الأداء؟'],
  'منشور': ['أوقات النشر المثالية', 'كيف أزيد التفاعل؟'],
  'متابع': ['استراتيجيات زيادة المتابعين', 'جودة vs كمية المتابعين'],
  'إعلان': ['الميزانية المناسبة', 'اختيار الجمهور المستهدف'],
  
  // استثمار ومال
  'سهم': ['كيف أحلل الأسهم؟', 'متى أبيع؟', 'إدارة المخاطر'],
  'استثمار': ['أفضل الصناديق', 'التنويع', 'الأخطاء الشائعة'],
  'محفظة': ['كيف أوزن المحفظة؟', 'إعادة التوازن', 'المراجعة الدورية'],
  
  // صحة ولياقة
  'تمرين': ['جدول تمارين كامل', 'الإحماء الصحيح', 'تجنب الإصابات'],
  'بروتين': ['مصادر البروتين', 'الكمية اليومية', 'التوقيت المناسب'],
  'وزن': ['حساب الوزن المثالي', 'الزيادة الصحية', 'الثبات'],
  'عضلات': ['تمارين محددة', 'فترة الراحة', 'التغذية المناسبة'],
  
  // تقنية وبرمجة
  'كود': ['أفضل الممارسات', 'أدوات تساعد', 'حل الأخطاء الشائعة'],
  'API': ['التوثيق', 'أمثلة عملية', 'معالجة الأخطاء'],
  'قاعدة بيانات': ['اختيار النوع المناسب', 'التحسين', 'النسخ الاحتياطي'],
  
  // مهارات وتطوير
  'مهارة': ['كيف أتعلمها؟', 'المدة الزمنية', 'أفضل المصادر'],
  'تعلم': ['خطة تعلم', 'قياس التقدم', 'التحفيز والاستمرار'],
  'دورة': ['أفضل المنصات', 'الشهادات المعترف بها', 'التكلفة'],
};

// ===== 2. اقتراحات حسب نوع السؤال =====

const QUESTION_TYPE_SUGGESTIONS: Record<string, string[]> = {
  'كيف': [
    'هل هناك طريقة أسهل؟',
    'ما المدة الزمنية المتوقعة؟',
    'أمثلة عملية على ذلك',
    'الأخطاء الشائعة وكيفية تجنبها'
  ],
  
  'ماذا': [
    'لماذا هذا الخيار بالتحديد؟',
    'هل هناك بدائل؟',
    'كيف أبدأ؟',
    'نصائح إضافية'
  ],
  
  'لماذا': [
    'كيف أطبق هذا عملياً؟',
    'هل هناك استثناءات؟',
    'أمثلة واقعية',
    'كيف أقنع الآخرين بذلك؟'
  ],
  
  'متى': [
    'ما البدائل إذا لم يكن الوقت مناسباً؟',
    'كيف أخطط مسبقاً؟',
    'ما المدة المتوقعة؟',
    'كيف أتابع الجدول؟'
  ],
  
  'أين': [
    'هل يوجد خيارات أونلاين؟',
    'ما الأقرب لموقعي؟',
    'المقارنة بين الخيارات',
    'نصائح للزيارة الأولى'
  ],
  
  'هل': [
    'ما الخيارات المتاحة؟',
    'إيجابيات وسلبيات كل خيار',
    'تجارب الآخرين',
    'كيف أقرر؟'
  ],
};

// ===== 3. اقتراحات عامة للمتابعة =====

const FOLLOW_UP_SUGGESTIONS = [
  'هل يمكنك التوضيح أكثر؟',
  'ما النصيحة الأهم هنا؟',
  'أمثلة عملية على ذلك',
  'كيف أتجنب الأخطاء الشائعة؟',
  'ما الخطوة التالية؟',
  'موارد أو مصادر إضافية',
];

// ===== 4. الدالة الرئيسية: تحليل رد الخبير =====

export function getContextualSuggestions(
  expertResponse: string,
  expertId: string
): string[] {
  const suggestions: Set<string> = new Set();
  const responseLC = expertResponse.toLowerCase();
  
  // 1. ابحث عن الكلمات المفتاحية
  for (const [keyword, keywordSugs] of Object.entries(KEYWORD_SUGGESTIONS)) {
    if (responseLC.includes(keyword)) {
      // أضف اقتراح أو اثنين من هذه الكلمة
      const random = keywordSugs.sort(() => Math.random() - 0.5);
      random.slice(0, 2).forEach(sug => suggestions.add(sug));
    }
  }
  
  // 2. حلل نوع السؤال الأصلي (إذا كان موجوداً في الرد)
  for (const [questionWord, questionSugs] of Object.entries(QUESTION_TYPE_SUGGESTIONS)) {
    if (responseLC.includes(questionWord)) {
      const random = questionSugs.sort(() => Math.random() - 0.5);
      suggestions.add(random[0]);
    }
  }
  
  // 3. أضف اقتراحات خاصة بالخبير
  const expertSpecific = getExpertSpecificSuggestions(expertId, responseLC);
  expertSpecific.forEach(sug => suggestions.add(sug));
  
  // 4. إذا لم نجد اقتراحات كافية، أضف من الاقتراحات العامة
  if (suggestions.size < 3) {
    const random = FOLLOW_UP_SUGGESTIONS.sort(() => Math.random() - 0.5);
    random.slice(0, 3 - suggestions.size).forEach(sug => suggestions.add(sug));
  }
  
  // 5. أرجع 4-5 اقتراحات فقط
  return Array.from(suggestions).slice(0, 5);
}

// ===== 5. اقتراحات خاصة لكل خبير =====

function getExpertSpecificSuggestions(expertId: string, response: string): string[] {
  const specificSuggestions: Record<string, Record<string, string[]>> = {
    // منال الإجرائية (خدمات حكومية)
    'legal-2': {
      'وكالة': ['كيف ألغي الوكالة؟', 'مدة صلاحية الوكالة', 'الوكالة الخاصة vs العامة'],
      'رخصة': ['رسوم التجديد', 'الوثائق المطلوبة', 'كم يستغرق الإصدار؟'],
      'أبشر': ['تحديث البيانات', 'حل مشكلة الدخول', 'الخدمات المتاحة'],
    },
    
    // جمانة الرقمية (تسويق)
    'biz-2': {
      'محتوى': ['جدول نشر أسبوعي', 'أدوات التصميم', 'قياس الأداء'],
      'متابع': ['زيادة التفاعل', 'جودة المتابعين', 'التحليلات'],
      'إعلان': ['تحديد الميزانية', 'الجمهور المستهدف', 'قياس ROI'],
    },
    
    // نورة الحرة (دخل إضافي)
    'money-2': {
      'مشروع': ['دراسة الجدوى', 'التمويل', 'إدارة الوقت'],
      'فريلانس': ['المنصات الأفضل', 'التسعير', 'العقود'],
      'دخل': ['زيادة الدخل', 'التنويع', 'الضرائب'],
    },
    
    // د. محمد الاستثماري
    'money-4': {
      'سهم': ['التحليل الفني', 'وقت البيع', 'إدارة المخاطر'],
      'محفظة': ['التنويع', 'إعادة التوازن', 'المراجعة'],
      'صكوك': ['المقارنة مع الأسهم', 'العوائد', 'المخاطر'],
    },
    
    // كابتن عزام (لياقة)
    'health-2': {
      'تمرين': ['الجدول الأسبوعي', 'الراحة', 'الإصابات'],
      'عضلات': ['البروتين', 'التمارين المناسبة', 'فترة الاستشفاء'],
      'وزن': ['الزيادة الصحية', 'الثبات', 'الحساب الصحيح'],
    },
    
    // د. تالا (تغذية)
    'health-1': {
      'نظام': ['خطة أسبوعية', 'الوجبات', 'المكملات'],
      'سعرات': ['الحساب الصحيح', 'التوزيع', 'التتبع'],
      'صيام': ['الأنواع', 'الفوائد', 'المخاطر'],
    },
  };
  
  const expertSugs = specificSuggestions[expertId] || {};
  const results: string[] = [];
  
  for (const [keyword, suggestions] of Object.entries(expertSugs)) {
    if (response.includes(keyword)) {
      results.push(...suggestions.slice(0, 2));
    }
  }
  
  return results;
}

// ===== 6. دالة مساعدة: اقتراحات حسب طول الرد =====

export function getSuggestionsByResponseLength(responseLength: number): string[] {
  if (responseLength < 100) {
    // رد قصير - اطلب تفاصيل أكثر
    return [
      'هل يمكنك التوضيح أكثر؟',
      'أمثلة عملية على ذلك',
      'تفاصيل إضافية من فضلك',
    ];
  } else if (responseLength < 300) {
    // رد متوسط - اسأل عن الخطوات التالية
    return [
      'ما الخطوة التالية؟',
      'كيف أطبق هذا عملياً؟',
      'نصائح إضافية',
    ];
  } else {
    // رد طويل - اسأل عن ملخص أو نقاط محددة
    return [
      'ما أهم نقطة يجب التركيز عليها؟',
      'ملخص سريع',
      'كيف أبدأ التطبيق؟',
    ];
  }
}

// ===== 7. دالة لتنظيف الاقتراحات المكررة =====

export function deduplicateSuggestions(suggestions: string[]): string[] {
  const seen = new Set<string>();
  const unique: string[] = [];
  
  for (const sug of suggestions) {
    const normalized = sug.toLowerCase().trim();
    if (!seen.has(normalized)) {
      seen.add(normalized);
      unique.push(sug);
    }
  }
  
  return unique;
}

// ===== 8. الاحتفاظ بالدوال القديمة للتوافق =====

export const generateContextualSuggestions = getContextualSuggestions;

export const getInitialSuggestions = (expertId: string): string[] => {
  const initialSuggestions: Record<string, string[]> = {
    'money-4': ['بناء محفظة استثمارية', 'الفرق بين الصكوك والأسهم', 'تحليل سهم في تاسي'],
    'career-2': ['تحسين السيرة الذاتية', 'الإجابة المثالية للمقابلة', 'التفاوض على الراتب'],
    'money-1': ['تحليل: الإيجار أم التملك؟', 'أفضل الأحياء للاستثمار', 'التمويل العقاري الأفضل'],
    'money-2': ['مشاريع برأس مال قليل', 'توثيق العمل الحر', 'تسعير الخدمات'],
    'biz-2': ['أوقات النشر الذهبية', 'محتوى فيروسي', 'أفكار Hooks جذابة'],
    'biz-1': ['استراتيجية النمو', 'تمييز الهوية التجارية', 'زيادة المبيعات'],
    'self-1': ['التنفس الصندوقي للقلق', 'الفصل بين العمل والحياة', 'التعامل مع الأفكار السلبية'],
    'health-1': ['خطة غذائية للطاقة', 'التغلب على الخمول', 'تحسين النوم'],
    'self-3': ['قول "لا" بلباقة', 'التعامل مع الزملاء المتطلبين', 'رسم حدود صحية'],
    'ai-1': ['كتابة Prompt دقيق', 'أدوات AI للتلخيص', 'Chain of Thought'],
    'tech-3': ['التحقق من فكرة التطبيق', 'Business Model Canvas', 'Pitch Deck'],
    'career-1': ['المهارات الناعمة المطلوبة', 'تغيير المسار المهني', 'الإنجليزية للأعمال'],
    'legal-1': ['مراجعة عقد عمل', 'تأسيس شركة محدودة', 'مكافأة نهاية الخدمة'],
    'legal-2': ['وكالة إلكترونية عبر ناجز', 'حل إيقاف الخدمات', 'نقل كفالة موظف'],
    'tech-1': ['المرحلة الثانية فاتورة', 'حل المشاكل التقنية', 'جاهزية نظام ERP'],
    'tech-2': ['اختيار Tech Stack', 'تصميم قابل للتوسع', 'مقارنة AWS و Azure'],
    'ai-2': ['الديتوكس الرقمي', 'حماية البيانات مع AI', 'التوازن الرقمي'],
    'health-2': ['تمارين مقاومة للمبتدئين', 'التضخيم vs التنشيف', 'كارديو لحرق الدهون'],
    'career-3': ['اختيار التخصص الجامعي', 'مذاكرة القدرات', 'أفضل الجامعات'],
    'biz-3': ['خطة صانع المحتوى', 'سيناريو ريلز جذاب', 'عناوين إعلانية قوية'],
    'self-2': ['أسئلة لفتح مواضيع', 'التغلب على الرهاب الاجتماعي', 'علاقات Networking'],
    'money-3': ['قاعدة 50/30/20', 'كرة الثلج لسداد الديون', 'بناء صندوق الطوارئ'],
  };
  
  return initialSuggestions[expertId] || ['كيف يمكنك مساعدتي؟', 'ما خبرتك؟', 'ابدأ بنصيحة'];
};
